<!--
%\VignetteEngine{knitr::knitr}
%\VignetteIndexEntry{An introduction to using the ImmuneSpaceR package}
-->

# A simple introduction on using the ImmuneSpaceR package

This package provides a *thin* wrapper around `Rlabkey` and connects to the **ImmuneSpace* database, making it easier to fetch *datasets*, including gene expression data, hai, and so forth, from specific studies. 

## Configuration

ImmuneSpaceR uses the `options` mechanism in R to find the values of three variables. These will typically be set by the LabKey system when a script is running on ImmuneSpace, but if you work remotely, you can set them in your global environment, or ImmuneSpaceR will assign default values if they're missing. The defaults may or may not work for you, so it's best to set them. 

```{r echo=TRUE}
labkey.url.base = "https://www.immunespace.org"
labkey.url.path = "Studies/SDY269"
labkey.user.email = "unknown_user at not_a_real_domain.org"
```

The first is the URI to the ImmuneSpace system.
The second is the path to the study you wish to access. In this case, we are going to access `SDY269`. All studies are under the `Studies` folder. Always.
The third is the email address used to register on ImmuneSpace. This optional variable is used to track who generated a given report.

Finally you will need a `.netrc` file in your home directory that will contain a `machine` name (hostname of ImmuneSpace), and `login` and `password`. See [here](https://www.labkey.org/wiki/home/Documentation/page.view?name=netrc) for more information.

A netrc file may look like this:
```
machine www.immunespace.org
login myuser@domain.com
password supersecretpassword
```

### Set up your netrc file now
Put it in your home directory. 
If you type:
``` 
ls ~/.netrc
```
at the command prompt, you should see it there. If it's not there, create one now. Make sure you have a valid login and password. If you don't have one, go to [ImmuneSpace](http://www.immunespace.org) now and set yourself up with an account. 

## Instantiate a connection

Let's instantiate a connection to ImmuneSpace. First, we need the configuration variables. These would normally be set up by LabKey when running locally on the ImmuneSpace server. Since we are running remotely, we need to define them.

```{r, message=FALSE}
require(ImmuneSpaceR)
labkey.url.base = "https://www.immunespace.org" 
labkey.url.path = "Studies/SDY269"
```

We'll be looking at study `SDY269`. If you want to use a different study, change that string. The connections have state, so you can instantiate multiple connections to different studies simultaneously.

```{r CreateConnection}
sdy269 <- CreateConnection(study = "SDY269")
sdy269
```

The call to `CreateConnection` instantiates the connection and it initializes itself using the `labkey.*` variables, assigns them to `options`, and those are used by the connection. The `study` parameter can be used to override the `labkey.url.path`.  Printing the object shows where it's connected, to what study, and the available data sets and gene expression matrices.

## Fetching data sets and gene expression matrices

We can grab a named data set easily enough.

```{r getDataset}
sdy269$getDataset("hai")
```


The *sdy269* object is an **S5** class, so it behaves like a true object. Functions (like `getDataset`) are members of the object, thus the `$` semantics to access member functions.
The first time you retrieve a data set, it will contact the database. The data is cached locally, so the next time you call `getDataset` on the same dataset, it will retrieve the cached local copy. This is much faster. 


To get only a subset of the data and speed up the download, filters can be 
passed to `getDataset`. The filters are created using the `makeFilter` function
of the `Rlabkey` package.
```{r getDataset-filter, message = FALSE}
library(Rlabkey)
myFilter <- makeFilter(c("gender", "EQUAL", "Female"))
hai <- sdy269$getDataset("hai", colFilter = myFilter)
```
See `?makeFilter` for more information on the syntax.

We can also grab a gene expression matrix

```{r getGEMatrix}
sdy269$getGEMatrix("LAIV_2008")
```

The object contacts the DB and downloads the matrix file. This is stored and cached locally as a `data.table`. The next time you access it, it will be much faster since it won't need to contact the database again.

It is also possible to call this function using multiple matrix names. In this
case, all the matrices are downloaded and combined into a single `ExpressionSet`.
```{r getGEMatrix-multiple}
sdy269$getGEMatrix(c("TIV_2008", "LAIV_2008"))
```

Finally, the summary argument will let you download the matrix with gene symbols
in place of priobe ids.
```{r getGEMatrix-summary}
gs <- sdy269$getGEMatrix("TIV_2008", summary = TRUE)
```

## Errors
If you try to grab a dataset that doesn't exist, the object should tell you by giving you an error.

```{r}
result <- sdy269$getDataset("mickey_mouse")
```

If the connection was created with `verbose = TRUE`, some functions will display
additional informations such as the valid dataset names.

## Quick plots
A quick plot of a data set can be generated using the `quick_plot` function.

`quick_plot` automatically chooses the type of plot depending on the selected 
dataset.

```{r, dev='CairoPNG'}
sdy269$quick_plot("hai")

sdy269$quick_plot("elisa")
```

However, the `type` argument can be used to manually select from "boxplot",
"heatmap", "violin" and "line".

## Cross study connections
To fetch data from multiple studies, simply create a connection at the project level.

```{r, cross-connection}
con <- CreateConnection("")
```

This will instantiate a connection at the `Studies` level. Most functions work
cross study connections just like they do on single studies.

You can get a list of datasets and gene expression matrices available accross 
all studies.
```{r, cross-connection-print}
con
```

Likewise, `quick_plot` will plot accross studies. Note that in most cases the
datasets will have too many cohorts/subjects, making the filtering of the data
a necessity. The `colFilter` argument can be used here, as described in the 
`getDataset` sectionm.
```{r cross-connection-qplot, dev='CairoPNG'}
plotFilter <- makeFilter(c("cohort", "IN", "TIV 2010;TIV Group 2008"))
con$quick_plot("elispot", filter = plotFilter)
```
The figure above shows the ELISPOT results for two different years of TIV 
vaccine cohorts.

